<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Broke Messenger</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --ios-blue: #007AFF;
            --glass: rgba(255, 255, 255, 0.75);
            --text-color: #000;
            --msg-in: #e5e5ea;
            --bg-blur: blur(30px);
        }

        body.dark-mode {
            --glass: rgba(30, 30, 30, 0.85);
            --text-color: #fff;
            --msg-in: #3a3a3c;
            background-color: #000;
        }

        * { box-sizing: border-box; transition: background 0.3s, color 0.3s; -webkit-tap-highlight-color: transparent; }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background: #000 url('https://w.wallhaven.cc/full/ex/wallhaven-ex96pw.png') no-repeat center center fixed;
            background-size: cover; overflow: hidden; color: var(--text-color);
        }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { display: none; height: 100vh; width: 100vw; }
        .active-screen { display: flex; animation: slideUp 0.4s cubic-bezier(0.1, 0.7, 0.1, 1); }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* –í—Ö–æ–¥ */
        #auth-screen { justify-content: center; align-items: center; backdrop-filter: blur(50px); }
        .auth-card { background: var(--glass); padding: 40px; border-radius: 35px; width: 320px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }

        .app-container { display: flex; width: 100%; height: 100%; }

        /* –°–∞–π–¥–±–∞—Ä */
        .sidebar {
            width: 320px; background: var(--glass); backdrop-filter: var(--bg-blur);
            border-right: 0.5px solid rgba(125,125,125,0.2); display: flex; flex-direction: column;
        }

        .profile-section { padding: 60px 20px 20px; cursor: pointer; border-bottom: 0.5px solid rgba(125,125,125,0.2); }
        .avatar-main {
            width: 80px; height: 80px; border-radius: 50%; background: var(--ios-blue);
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 32px; font-weight: bold; margin-bottom: 15px;
            background-size: cover; background-position: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .menu-item { padding: 16px 20px; cursor: pointer; display: flex; align-items: center; gap: 15px; font-size: 17px; }
        .menu-item:hover { background: rgba(125,125,125,0.1); }

        /* –ß–∞—Ç */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.02); }
        .chat-header {
            padding: 15px 20px; background: var(--glass); backdrop-filter: var(--bg-blur);
            display: flex; align-items: center; gap: 15px; border-bottom: 0.5px solid rgba(125,125,125,0.2);
        }

        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .message { 
            max-width: 75%; padding: 12px 18px; border-radius: 22px; font-size: 16px; 
            position: relative; cursor: pointer; line-height: 1.4;
        }
        .m-in { background: var(--msg-in); align-self: flex-start; border-bottom-left-radius: 5px; }
        .m-out { background: var(--ios-blue); color: white; align-self: flex-end; border-bottom-right-radius: 5px; }

        .reaction-badge {
            position: absolute; bottom: -10px; right: 12px; background: white;
            border-radius: 12px; padding: 2px 7px; font-size: 13px; color: #000; box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
        .input-box { padding: 15px 15px 35px; display: flex; gap: 12px; background: var(--glass); backdrop-filter: var(--bg-blur); }
        .ios-input {
            background: rgba(120,120,128,0.15); border: none; border-radius: 20px;
            padding: 12px 18px; flex: 1; color: var(--text-color); outline: none; font-size: 16px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100; justify-content: center; align-items: center;
        }
        .modal-content { background: var(--glass); backdrop-filter: blur(40px); width: 340px; border-radius: 35px; padding: 30px; text-align: center; }

        #emoji-menu {
            display: none; position: absolute; background: var(--glass); border-radius: 25px;
            padding: 12px; gap: 15px; z-index: 1000; box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }
        .emoji-btn { font-size: 26px; cursor: pointer; transition: transform 0.2s; }
        .emoji-btn:hover { transform: scale(1.3); }
    </style>
</head>
<body>

    <div id="auth-screen" class="screen">
        <div class="auth-card">
            <h1 style="margin:0; font-size: 32px;">Broke</h1>
            <p style="opacity:0.5; margin-bottom:25px;">The best code</p>
            <input type="text" id="username-input" placeholder="@username" class="ios-input" style="width:100%; margin-bottom:15px; text-align:center;">
            <button onclick="handleLogin()" style="width:100%; padding:15px; background:var(--ios-blue); color:white; border:none; border-radius:18px; font-weight:bold; cursor:pointer; font-size:16px;">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <div id="app-screen" class="screen app-container">
        <div class="sidebar">
            <div class="profile-section" onclick="openModal('me')">
                <div class="avatar-main" id="my-avatar-ui"></div>
                <strong id="my-name-ui" style="font-size:20px;">User</strong><br>
                <small id="my-user-ui" style="opacity:0.5;">@username</small>
            </div>
            
            <div style="padding: 20px;">
                <input type="text" placeholder="–ü–æ–∏—Å–∫ @user..." class="ios-input" style="width:100%;" onkeyup="searchUser(event)">
            </div>

            <div class="menu-item" onclick="openModal('me')">üë§ –ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å</div>
            <div class="menu-item" onclick="toggleDarkMode()">üåì –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</div>
            <div class="menu-item" onclick="updateAvatar()">üñº –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</div>
            <div class="menu-item" onclick="checkAdmin()">üõ† –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <div class="avatar-main" style="width:45px; height:45px; font-size:16px; margin:0;" id="chat-target-av"></div>
                <div>
                    <strong id="chat-target-name" style="font-size:17px;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</strong><br>
                    <small style="color:var(--ios-blue); font-weight:500;">–≤ —Å–µ—Ç–∏</small>
                </div>
            </div>
            <div class="messages-container" id="chat-box">
                <center style="opacity:0.4; margin-top:50px;">–í–≤–µ–¥–∏—Ç–µ @username –≤ –ø–æ–∏—Å–∫–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</center>
            </div>
            <div class="input-box">
                <input type="text" id="msg-field" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." class="ios-input">
                <button onclick="sendMessage()" style="border:none; background:none; color:var(--ios-blue); font-size:32px; cursor:pointer; padding:0;">‚¨Ü</button>
            </div>
        </div>
    </div>

    <div id="emoji-menu">
        <span class="emoji-btn" onclick="applyReaction('üëç')">üëç</span>
        <span class="emoji-btn" onclick="applyReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span class="emoji-btn" onclick="applyReaction('üî•')">üî•</span>
        <span class="emoji-btn" onclick="applyReaction('üòÇ')">üòÇ</span>
    </div>

    <div id="profile-modal" class="modal" onclick="closeModals(event)">
        <div class="modal-content">
            <div class="avatar-main" style="width:110px; height:110px; font-size:45px; margin: 0 auto 15px;" id="modal-av"></div>
            <h2 id="modal-name" style="margin:0;"></h2>
            <p id="modal-user" style="color:var(--ios-blue); margin:5px 0 15px; font-weight:500;"></p>
            <div id="modal-nfts" style="margin-bottom:15px;"></div>
            <div style="text-align: left; border-top: 1px solid rgba(125,125,125,0.2); padding-top:15px; font-size:15px;">
                <p><b>–û —Å–µ–±–µ:</b> <span id="modal-bio">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Broke</span></p>
                <p><b>–ù–æ–º–µ—Ä:</b> <span id="modal-phone"></span></p>
            </div>
            <button onclick="closeModals(event, true)" class="ios-input" style="background:var(--ios-blue); color:white; width:100%; margin-top:20px; font-weight:bold;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <h3>üõ† –ü–∞–Ω–µ–ª—å –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h3>
            <button class="menu-item" style="width:100%; border-radius:15px; margin-bottom:8px; background:rgba(125,125,125,0.1);" onclick="adminAction('nft')">üíé –í—ã–¥–∞—Ç—å NFT –ø–æ–¥–∞—Ä–æ–∫</button>
            <button class="menu-item" style="width:100%; border-radius:15px; background:rgba(125,125,125,0.1);" onclick="adminAction('stats')">üìà –ù–∞–∫—Ä—É—Ç–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
            <button onclick="closeModals(event, true)" class="ios-input" style="width:100%; margin-top:25px;">–í—ã–π—Ç–∏ –∏–∑ –ø–∞–Ω–µ–ª–∏</button>
        </div>
    </div>

    <script>
        const socket = io(); 
        let userState = JSON.parse(localStorage.getItem('broke_final_v1')) || null;
        let activeChat = null;
        let selectedMsg = null;

        window.onload = () => {
            if (userState) {
                if (userState.isDark) document.body.classList.add('dark-mode');
                startApp();
            } else {
                document.getElementById('auth-screen').classList.add('active-screen');
            }
        };

        function handleLogin() {
            const input = document.getElementById('username-input').value.trim();
            if (input.length < 2) return alert("–ù–∏–∫ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π");
            userState = {
                username: input.startsWith('@') ? input : '@' + input,
                name: input.replace('@', ''),
                isDark: false, avatar: '', nfts: [],
                phone: "+7 " + Math.floor(Math.random() * 9000000000)
            };
            save(); startApp();
        }

        function save() { localStorage.setItem('broke_final_v1', JSON.stringify(userState)); }

        function startApp() {
            document.getElementById('auth-screen').classList.remove('active-screen');
            document.getElementById('app-screen').classList.add('active-screen');
            updateSidebar();
            socket.emit('online', userState.username);
        }

        function updateSidebar() {
            document.getElementById('my-name-ui').innerText = userState.name;
            document.getElementById('my-user-ui').innerText = userState.username;
            const av = document.getElementById('my-avatar-ui');
            if (userState.avatar) { av.style.backgroundImage = `url(${userState.avatar})`; av.innerText = ''; }
            else { av.innerText = userState.name[0].toUpperCase(); av.style.backgroundImage = 'none'; }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            userState.isDark = document.body.classList.contains('dark-mode');
            save();
        }

        function updateAvatar() {
            const url = prompt("–í—Å—Ç–∞–≤—å—Ç–µ URL –∫–∞—Ä—Ç–∏–Ω–∫–∏:");
            if (url) { userState.avatar = url; save(); updateSidebar(); }
        }

        function searchUser(e) {
            if (e.key === "Enter") {
                const target = e.target.value.trim();
                activeChat = target.startsWith('@') ? target : '@' + target;
                document.getElementById('chat-target-name').innerText = activeChat;
                document.getElementById('chat-target-av').innerText = activeChat[1].toUpperCase();
                document.getElementById('chat-box').innerHTML = "<center style='opacity:0.3; margin-top:30px;'>–ß–∞—Ç —Å " + activeChat + " –æ—Ç–∫—Ä—ã—Ç</center>";
            }
        }

        function sendMessage() {
            const input = document.getElementById('msg-field');
            if (!input.value || !activeChat) return;
            renderMsg(input.value, 'm-out');
            socket.emit('private_msg', { to: activeChat, from: userState.username, text: input.value });
            input.value = "";
        }

        socket.on('receive_msg', (data) => {
            if (data.from === activeChat) renderMsg(data.text, 'm-in');
            else alert("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç " + data.from);
        });

        function renderMsg(text, type) {
            const div = document.createElement('div');
            div.className = 'message ' + type;
            div.innerText = text;
            div.onclick = (e) => {
                selectedMsg = div;
                const menu = document.getElementById('emoji-menu');
                menu.style.display = 'flex';
                menu.style.top = e.pageY + 'px';
                menu.style.left = (e.pageX - 50) + 'px';
                e.stopPropagation();
            };
            document.getElementById('chat-box').appendChild(div);
            document.getElementById('chat-box').scrollTop = 9999;
        }

        function applyReaction(emoji) {
            let badge = selectedMsg.querySelector('.reaction-badge') || document.createElement('span');
            badge.className = 'reaction-badge';
            badge.innerText = emoji;
            selectedMsg.appendChild(badge);
            document.getElementById('emoji-menu').style.display = 'none';
        }

        function checkAdmin() {
            const log = prompt("–õ–æ–≥–∏–Ω:");
            const pass = prompt("–ü–∞—Ä–æ–ª—å:");
            if (log === "–ø–∞—Ä–∞–º–æ–≤" && pass === "565811") {
                document.getElementById('admin-modal').style.display = 'flex';
            } else alert("–û—Ç–∫–∞–∑ –≤ –¥–æ—Å—Ç—É–ø–µ");
        }

        function adminAction(type) {
            if (type === 'nft') {
                const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ NFT:");
                if (title) { userState.nfts.push(title); save(); alert("NFT –¥–æ–±–∞–≤–ª–µ–Ω–æ!"); }
            } else alert("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ –Ω–∞–∫—Ä—É—á–µ–Ω–∞!");
        }

        function openModal(who) {
            const modal = document.getElementById('profile-modal');
            modal.style.display = 'flex';
            const isMe = who === 'me';
            const d = isMe ? userState : { name: activeChat, username: activeChat, phone: "–°–∫—Ä—ã—Ç", avatar: '', nfts: [] };

            document.getElementById('modal-name').innerText = d.name;
            document.getElementById('modal-user').innerText = d.username;
            document.getElementById('modal-phone').innerText = d.phone;
            const mav = document.getElementById('modal-av');
            if (d.avatar) { mav.style.backgroundImage = `url(${d.avatar})`; mav.innerText = ''; }
            else { mav.innerText = d.name[isMe ? 0 : 1].toUpperCase(); mav.style.backgroundImage = 'none'; }

            document.getElementById('modal-nfts').innerHTML = isMe ? userState.nfts.map(n => 
                `<span style='background:linear-gradient(135deg, gold, orange); color:black; padding:4px 10px; border-radius:12px; font-size:12px; margin:3px; display:inline-block; font-weight:bold;'>üíé ${n}</span>`
            ).join('') : '';
        }

        function closeModals(e, force = false) {
            if (force || e.target.className === 'modal') {
                document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            }
            document.getElementById('emoji-menu').style.display = 'none';
        }

        document.addEventListener('click', () => { 
            document.getElementById('emoji-menu').style.display = 'none'; 
        });
    </script>
</body>
</html>
