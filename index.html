<!DOCTYPE html><html lang="ru"><head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>TeleClone Web</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg: #0e1621; --side: #17212b; --acc: #2481cc;
            --msg-out: #2b5278; --msg-in: #182533;
            --text: #fff; --text-sec: #708499;
            --font: 'Inter', -apple-system, sans-serif;
        }
        body.light {
            --bg: #f4f4f5; --side: #ffffff; --acc: #3390ec;
            --msg-out: #eeffdb; --msg-in: #ffffff; --text: #000;
        }
        * { box-sizing: border-box; font-family: var(--font); margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; }

        .app { display: flex; height: 100vh; }
        
        /* Sidebar Styles */
        .sidebar { width: 350px; background: var(--side); border-right: 1px solid rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .search-container { padding: 15px; }
        .tg-input { width: 100%; background: var(--bg); border: 2px solid transparent; border-radius: 12px; padding: 10px 15px; color: var(--text); outline: none; transition: 0.2s; }
        .tg-input:focus { border-color: var(--acc); }

        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 12px 15px; display: flex; items-center; gap: 12px; cursor: pointer; transition: 0.2s; position: relative; }
        .chat-item:hover { background: rgba(255,255,255,0.05); }
        .chat-item.active { background: var(--acc); }

        /* Avatar System */
        .avatar { width: 54px; height: 54px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; position: relative; background-size: cover; }
        .online-badge { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; background: #4cd964; border: 2px solid var(--side); border-radius: 50%; }

        /* Chat Viewport */
        .main { flex: 1; display: flex; flex-direction: column; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; background-color: var(--bg); }
        .top-bar { height: 60px; background: var(--side); display: flex; align-items: center; padding: 0 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        
        .bubble { max-width: 450px; padding: 8px 12px; border-radius: 15px; font-size: 15px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .bubble.out { align-self: flex-end; background: var(--msg-out); border-bottom-right-radius: 4px; color: white; }
        .bubble.in { align-self: flex-start; background: var(--msg-in); border-bottom-left-radius: 4px; }
        .bubble.pulse { animation: flash 1.5s ease; }
        
        @keyframes flash { 0% { background: var(--acc); } 100% { background: var(--msg-in); } }

        .input-area { padding: 15px 20px; background: var(--side); display: flex; gap: 10px; align-items: flex-end; }
        .expanding-input { flex: 1; min-height: 40px; max-height: 200px; background: var(--bg); border-radius: 12px; padding: 10px; outline: none; white-space: pre-wrap; }

        /* Admin / Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--side); padding: 30px; border-radius: 20px; width: 320px; text-align: center; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        .ripple { position: relative; overflow: hidden; }
        .ripple-effect { position: absolute; border-radius: 50%; background: rgba(255,255,255,0.3); transform: scale(0); animation: rip 0.6s linear; }
        @keyframes rip { to { transform: scale(4); opacity: 0; } }
    </style></head>
<body class="dark">

<div class="app">
    <div class="sidebar">
        <div class="search-container">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <h2 style="font-size:18px;">TeleClone</h2>
                <div id="adm-btn" style="display:none; cursor:pointer;" onclick="openModal('admin-modal')">ðŸ› </div>
            </div>
            <input type="text" id="search-bar" class="tg-input" placeholder="Search..." onkeyup="if(event.key==='Enter') startSearch(this.value)">
        </div>
        <div id="chat-list" class="chat-list"></div>
        <div style="padding:15px; border-top:1px solid rgba(0,0,0,0.1);">
            <button onclick="logout()" class="btn" style="background:transparent; color:#ff3b30; border:1px solid #ff3b30;">Logout</button>
        </div>
    </div>

    <div class="main">
        <div class="top-bar">
            <div id="active-chat-info" style="display:flex; align-items:center; gap:12px; cursor:pointer;" onclick="openProfile()">
                <div id="top-av" class="avatar" style="width:40px; height:40px; font-size:14px;"></div>
                <div>
                    <div id="top-name" style="font-weight:bold;">Select a chat</div>
                    <div id="top-status" style="font-size:12px; color:var(--text-sec);">offline</div>
                </div>
            </div>
        </div>
        <div id="msg-box" class="messages"></div>
        <div class="input-area">
            <div id="msg-input" class="expanding-input" contenteditable="true" data-placeholder="Write a message..."></div>
            <button onclick="sendMsg()" class="btn" style="width:40px; height:40px; border-radius:50%; background:var(--acc); margin:0;">â¬†</button>
        </div>
    </div>
</div>

<div id="admin-modal" class="modal" onclick="closeModals()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>Admin Panel</h3>
        <input type="text" id="adm-target" class="tg-input" placeholder="@username" style="margin:15px 0;">
        <button class="btn" style="background:#ff9500; color:white;" onclick="admAction('kick')">Kick Account</button>
        <button class="btn" style="background:#ff3b30; color:white;" onclick="admAction('ban')">Ban IP</button>
        <button class="btn" style="background:var(--acc); color:white;" onclick="admAction('nft')">Grant NFT</button>
    </div>
</div>

<script>
    const socket = io();
    let db = JSON.parse(localStorage.getItem('tele_self')) || null;
    let chats = JSON.parse(localStorage.getItem('tele_chats_v4')) || [];
    let msgs = JSON.parse(localStorage.getItem('tele_msgs_v4')) || {};
    let activeID = null;

    // --- Ð˜ÐÐ˜Ð¦Ð˜ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯ ---
    window.onload = () => {
        if(!db) {
            const nick = prompt("Enter @username:");
            db = { username: nick, name: nick.replace('@',''), isAdmin: nick==='@paramov', nfts: [] };
            localStorage.setItem('tele_self', JSON.stringify(db));
        }
        startApp();
    };

    function startApp() {
        if(db.isAdmin) document.getElementById('adm-btn').style.display='block';
        socket.emit('online', db.username);
        socket.emit('update_profile_broadcast', db);
        renderList();
    }

    // --- Ð§ÐÐ¢ Ð˜ Ð¡ÐžÐžÐ‘Ð©Ð•ÐÐ˜Ð¯ ---
    function startSearch(val) {
        const id = val.startsWith('@') ? val.toLowerCase() : '@' + val.toLowerCase();
        if(!chats.find(c => c.username === id)) {
            chats.push({ username: id, name: id.replace('@',''), nfts: [] });
            save();
        }
        openChat(id);
        renderList();
    }

    function openChat(id) {
        activeID = id;
        const u = chats.find(c => c.username === id);
        document.getElementById('top-name').innerText = u.name;
        document.getElementById('top-av').style.background = getGradient(id);
        document.getElementById('top-av').innerText = u.name[0];
        
        const box = document.getElementById('msg-box');
        box.innerHTML = '';
        (msgs[id] || []).forEach(m => appendMsg(m));
        renderList();
    }

    function sendMsg() {
        const inp = document.getElementById('msg-input');
        const text = inp.innerText.trim();
        if(!text || !activeID) return;

        const m = { id: Date.now(), from: db.username, to: activeID, text, time: Date.now() };
        if(!msgs[activeID]) msgs[activeID] = [];
        msgs[activeID].push(m);
        socket.emit('private_msg', m);
        appendMsg(m);
        inp.innerText = '';
        save();
    }

    socket.on('receive_msg', (d) => {
        if(!msgs[d.from]) msgs[d.from] = [];
        msgs[d.from].push(d);
        if(activeID === d.from) appendMsg(d);
        if(document.hidden) new Notification("New message from " + d.from, { body: d.text });
        save();
        renderList();
    });

    function appendMsg(m) {
        const div = document.createElement('div');
        div.className = `bubble ${m.from === db.username ? 'out' : 'in'}`;
        div.innerText = m.text;
        const box = document.getElementById('msg-box');
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    // --- UI Ð­Ð¤Ð¤Ð•ÐšÐ¢Ð« ---
    function renderList() {
        const list = document.getElementById('chat-list');
        list.innerHTML = chats.map(c => `
            <div class="chat-item ${activeID === c.username ? 'active' : ''}" onclick="openChat('${c.username}')">
                <div class="avatar" style="background:${getGradient(c.username)}">${c.name[0]}</div>
                <div style="flex:1">
                    <div style="font-weight:bold">${c.name} ${c.nfts?.map(n=>'ðŸ’Ž').join('') || ''}</div>
                    <div style="font-size:13px; color:var(--text-sec); opacity:0.8">This is the best code.</div>
                </div>
            </div>
        `).join('');
    }

    function getGradient(id) {
        const colors = [['#ff512f', '#dd2476'], ['#4facfe', '#00f2fe'], ['#667eea', '#764ba2'], ['#11998e', '#38ef7d']];
        const idx = id.length % colors.length;
        return `linear-gradient(45deg, ${colors[idx][0]}, ${colors[idx][1]})`;
    }

    // --- ÐÐ”ÐœÐ˜ÐÐšÐ ---
    function admAction(type) {
        const target = document.getElementById('adm-target').value;
        if(!target) return;
        if(type === 'kick') socket.emit('adm_kick_request', target);
        if(type === 'ban') socket.emit('adm_ban_ip', target);
        if(type === 'nft') {
            const u = chats.find(c => c.username === target);
            if(u) { u.nfts.push('ðŸ’Ž'); socket.emit('update_profile_broadcast', u); }
        }
        closeModals();
    }

    socket.on('kick_signal', (t) => { if(db.username === t) logout(); });

    function logout() { localStorage.clear(); location.reload(); }
    function save() { 
        localStorage.setItem('tele_chats_v4', JSON.stringify(chats));
        localStorage.setItem('tele_msgs_v4', JSON.stringify(msgs));
    }
    function openModal(id) { document.getElementById(id).style.display='flex'; }
    function closeModals() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }
</script>
</body></html>
